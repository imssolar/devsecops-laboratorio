name: Workflow
on:
    push:
        branches:
            - feature/devsecops

jobs:
    SAST:
      runs-on: ubuntu-latest
      steps:
        - name: checkout code
          uses: actions/checkout@v4

        - name: SonarCloud Scan
          uses: SonarSource/sonarcloud-github-action@master
          env:
            GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
            SONAR_TOKEN: ${{secrets.SONAR_TOKEN}}
        
        - name: Check for critical/High/Medium Vulnerabilities
          run: |
            issueValidate=$(curl -s -X GET -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/issues/search?branch=feature/devsecops&componentKeys=imssolar_devsecops-laboratorio&facets=severities' | jq '.facets[0].values[1].count')
            echo "Cantidad de issues bloqueantes: $issueValidate"
            if [ "$issueValidate" -gt 0 ]; then
                echo "Se encontraron issues bloqueantes. Se procede a detener el pipeline"
                exit 1
            else
                echo "No se encontraron issues bloqueantes. Se continua el escaneo"
            fi
name: Workflow
on:
    push:
        branches:
            - main
            - feature/devsecops

jobs:
    SAST:
      runs-on: ubuntu-latest
      steps:
        - name: checkout code
          uses: actions/checkout@v4

        - name: SonarCloud Scan
          uses: SonarSource/sonarcloud-github-action@master
          env:
            GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
            SONAR_TOKEN: ${{secrets.SONAR_TOKEN}}
        
        - name: Check for Critical/High/Medium Vulnerabilities
          run: |
           RESPONSE=$(curl -s -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/issues/search?componentKeys=imssolar_devsecops-laboratorio&resolved=false&types=VULNERABILITY,BUG&ps=1')
           TOTAL=$(echo "$RESPONSE" | jq '.total')
           echo "Total issues (Vulnerability + Bugs): $TOTAL"
           if [ ! -z "$TOTAL" ] && [ "$TOTAL" != "null" ] && [ "$TOTAL" -gt 0 ]; then
                echo "Se encontraron $TOTAL vulnerabilidades. Pipeline falla."
                exit 1
            else
                echo " No se encontraron vulnerabilidades."
            fi
        
name: Workflow
on:
  push:
    branches:
      - main
      - feature/devsecops

jobs:
  SAST:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          SONAR_TOKEN: ${{secrets.SONAR_TOKEN}}

      - name: Check for Critical/High/Medium Vulnerabilities with Sonar
        run: |
          RESPONSE=$(curl -s -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/issues/search?componentKeys=imssolar_devsecops-laboratorio&resolved=false&types=VULNERABILITY,BUG&ps=1')
          TOTAL=$(echo "$RESPONSE" | jq '.total')
          echo "Total issues (Vulnerability + Bugs): $TOTAL"
          if [ ! -z "$TOTAL" ] && [ "$TOTAL" != "null" ] && [ "$TOTAL" -gt 0 ]; then
               echo "Se encontraron $TOTAL vulnerabilidades. Pipeline falla."
               exit 1
           else
               echo " No se encontraron vulnerabilidades."
           fi
  SCA:
    runs-on: ubuntu-latest
    needs: SAST
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Debug JSON Content
        run:
          echo "Contenido del JSON:"
          cat reports/dependency-check-report.json | head -50
          echo ""
          echo "Estructura del JSON:"
          jq '.' reports/dependency-check-report.json | head -20
          
      - name: Run OWASP Dependency-check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "devsecops-laboratorio"
          path: "."
          format: "JSON"

      - name: Check for Critical/High/Medium Vulnerabilities in Dependencies
        run: |
          if [ -f "reports/dependency-check-report.json" ]; then
            CRITICAL=$(jq '[.dependencies[].vulnerabilities[] | select(.severity == "CRITICAL")] | length' reports/dependency-check-report.json)
            HIGH=$(jq '[.dependencies[].vulnerabilities[] | select(.severity == "HIGH")] | length' reports/dependency-check-report.json)
            TOTAL_CRITICAL=$((CRITICAL))
            TOTAL_HIGH=$((HIGH))

            if [ "$TOTAL_HIGH" -g 0 ]; then
              echo "Se encontraron $TOTAL_HIGH vulnerabilidades altas"
              exit 1
            else 
              echo "No se encontraron vulnerabilidades altas"
            fi
          else
            echo "Al parecer no hay vulnerabilidades"
          fi
             
